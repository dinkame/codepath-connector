<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח חוגים ופעילויות - מעוז אביב, הדר יוסף והסביבה</title>

   <!-- Social Media Preview Tags -->
<meta property="og:title" content="לוח החוגים של השכונה - מעוז אביב, הדר יוסף והסביבה">
<meta property="og:description" content="מצאו את החוג המושלם לילדים, נוער ומבוגרים במעוז אביב, הדר יוסף והסביבה.">
<meta property="og:image" content="https://kehilati.claudina.co.il/hugim/hugim-preview.jpg">
<meta property="og:url" content="https://kehilati.claudina.co.il/hugim/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="לוח החוגים של השכונה - מעוז אביב, הדר יוסף והסביבה">
<meta name="twitter:description" content="מצאו את החוג המושלם לילדים, נוער ומבוגרים במעוז אביב, הדר יוסף והסביבה.">
<meta name="twitter:image" content="https://kehilati.claudina.co.il/hugim/hugim-preview.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-800">לוח חוגים ופעילויות - מעוז אביב, הדר יוסף והסביבה</h1>
            <p class="text-lg text-gray-600 mt-2">מצאו את הפעילות המושלמת לילדים, נוער ומבוגרים</p>
            <p class="text-sm text-gray-500 mt-2" id="lastUpdated"></p>
        </header>

        <!-- Missing Info Notice -->
        <div class="bg-yellow-100 border-r-4 border-yellow-500 text-yellow-800 p-4 rounded-md mb-8 shadow" role="alert">
            <p class="font-bold">שימו לב, האפליקציה עדיין בהרצה!</p>
            <p>חסר לנו מידע על חוגים מהמקומות הבאים:</p>
            <ul class="list-disc list-inside mt-2">
                <li>בית ספר דוד ילין (מידע חלקי)</li>
                <li>בית ספר אלחריזי</li>
                <li>המרכז האולימפי (מידע חלקי)</li>
                <li>בית ספר גיל (מידע חלקי)</li>
            </ul>
            <p class="mt-2">מצאתן משהו שגוי או חסר? נשמח אם תשלחו הודעה לדינה.</p>
        </div>

        <!-- Filters Section -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-8 sticky top-0 z-10">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Search Input -->
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">חיפוש חופשי</label>
                    <input type="text" id="searchInput" placeholder="לדוגמה: כדורסל, אפרת..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                </div>
                <!-- Neighborhood Filter -->
                <div>
                    <label for="neighborhoodFilter" class="block text-sm font-medium text-gray-700">שכונה</label>
                    <select id="neighborhoodFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">כל השכונות</option>
                        <option value="מעוז אביב">מעוז אביב</option>
                        <option value="הדר יוסף/נאות אפקה">הדר יוסף/נאות אפקה</option>
                        <option value="תל ברוך צפון">תל ברוך צפון</option>
                    </select>
                </div>
                <!-- Type Filter -->
                <div>
                    <label for="typeFilter" class="block text-sm font-medium text-gray-700">סוג פעילות</label>
                    <select id="typeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">הכל</option>
                        <option value="community">מרכזים קהילתיים</option>
                        <option value="private">פרטיים</option>
                    </select>
                </div>
                <!-- Center Filter -->
                <div>
                    <label for="centerFilter" class="block text-sm font-medium text-gray-700">שם המקום</label>
                    <select id="centerFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">כל המקומות</option>
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                <!-- Day Filter -->
                <div>
                    <label for="dayFilter" class="block text-sm font-medium text-gray-700">יום בשבוע</label>
                    <select id="dayFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">כל הימים</option>
                        <option value="ראשון">ראשון</option>
                        <option value="שני">שני</option>
                        <option value="שלישי">שלישי</option>
                        <option value="רביעי">רביעי</option>
                        <option value="חמישי">חמישי</option>
                        <option value="שישי">שישי</option>
                        <option value="שבת">שבת</option>
                        <option value="ימים שונים">ימים שונים</option>
                    </select>
                </div>
                <!-- Age Group Filter -->
                <div>
                    <label for="ageFilter" class="block text-sm font-medium text-gray-700">קבוצת גיל</label>
                    <select id="ageFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">כל הגילאים</option>
                        <option value="גן">גן</option>
                        <option value="יסודי נמוך">יסודי (א'-ג')</option>
                        <option value="יסודי גבוה">יסודי (ד'-ו')</option>
                        <option value="חטיבה">חטיבה ומעלה</option>
                        <option value="מבוגרים">מבוגרים</option>
                    </select>
                </div>
                <!-- Category Filter -->
                <div class="lg:col-span-2">
                    <label for="categoryFilter" class="block text-sm font-medium text-gray-700">תחום</label>
                    <select id="categoryFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">הכל</option>
                        <option value="ספורט">ספורט</option>
                        <option value="אומנות לחימה">אומנות לחימה</option>
                        <option value="אומנות ויצירה">אומנות ויצירה</option>
                        <option value="מחול ותנועה">מחול ותנועה</option>
                        <option value="העשרה">העשרה</option>
                        <option value="מורים פרטיים">מורים פרטיים</option>
                        <option value="סדנאות">סדנאות</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Activities Grid -->
        <div id="activitiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Activity cards will be injected here by JavaScript -->
        </div>
        
        <!-- No Results Message -->
        <div id="noResultsMessage" class="text-center py-16 hidden">
            <h3 class="text-2xl font-semibold text-gray-700">לא נמצאו חוגים מתאימים</h3>
            <p class="text-gray-500 mt-2">אפשר לנסות לשנות את אפשרויות הסינון</p>
        </div>

    </div>

    <script>
        // --- DATA SOURCE ---
        // Initialize Supabase client
        const SUPABASE_URL = 'https://unwmtxtwfnljnvqjzfig.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud210eHR3Zm5sam52cWp6ZmlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDYyNjMsImV4cCI6MjA3MTYyMjI2M30.wSslNvSl_T2qpG5lxi66-o38XaExHaIaJFlv6d4QwiA';
        
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

        let activities = []; // Will be populated from Supabase

        // Fetch activities from Supabase
        async function fetchActivities() {
            try {
                if (!supabase) {
                    throw new Error('Supabase client not loaded');
                }

                console.log('Fetching activities from Supabase...');
                const { data, error } = await supabase
                    .from('classes')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    console.error('Error fetching activities:', error);
                    throw error;
                }

                console.log('Fetched activities:', data);

                // Convert Supabase data to the format expected by the existing JavaScript
                activities = data.map(cls => {
                    const metadata = cls.metadata || {};
                    const dayNames = ['', 'ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
                    
                    return {
                        name: cls.name,
                        instructor: cls.instructor || 'לא צוין',
                        day: metadata.originalDay || (cls.day_of_week ? dayNames[cls.day_of_week] : 'משתנה'),
                        age: metadata.originalAge || `${cls.age_min || ''}-${cls.age_max || ''}`,
                        time: metadata.originalTime || `${cls.start_time || ''}-${cls.end_time || ''}`,
                        location: cls.location || '',
                        center: metadata.center || '',
                        category: metadata.category || '',
                        ageTags: cls.tags || [],
                        type: metadata.type || 'community',
                        contact: metadata.contact || {},
                        description: cls.description,
                        neighborhood: metadata.neighborhood
                    };
                });

                console.log('Converted activities:', activities);
                return activities;
            } catch (error) {
                console.error('Failed to fetch activities from Supabase:', error);
                // Return empty array if fetch fails
                return [];
            }
        }

        // --- DOM ELEMENTS ---
        const grid = document.getElementById('activitiesGrid');
        const searchInput = document.getElementById('searchInput');
        const centerFilter = document.getElementById('centerFilter');
        const dayFilter = document.getElementById('dayFilter');
        const ageFilter = document.getElementById('ageFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const neighborhoodFilter = document.getElementById('neighborhoodFilter');
        const typeFilter = document.getElementById('typeFilter');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const lastUpdatedElement = document.getElementById('lastUpdated');

        // --- FUNCTIONS ---

        /**
         * Sets the last updated date.
         */
        function setLastUpdatedDate() {
            const date = new Date();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            lastUpdatedElement.textContent = `עדכון אחרון: ${day}.${month}.${year}`;
        }

        /**
         * Populates the center filter dropdown with unique center names based on selected neighborhood.
         */
        function populateCenterFilter(selectedNeighborhood = '', selectedType = '') {
            const neighborhoodMap = {
                "בית ספר מגן": "מעוז אביב",
                "חוג עצמאי - מעוז אביב": "מעוז אביב",
                "מורים פרטיים": "מעוז אביב",
                "הסדנאות של מורי": "מעוז אביב",
                "בית פרנקפורט": "הדר יוסף/נאות אפקה",
                "המרכז האולימפי": "הדר יוסף/נאות אפקה",
                "מרכז קהילתי הדר אפקה": "הדר יוסף/נאות אפקה",
                "קאנטרי נאות אפקה": "הדר יוסף/נאות אפקה",
                "בית ספר גיל": "הדר יוסף/נאות אפקה",
                "בית ספר דוד ילין": "הדר יוסף/נאות אפקה",
                "מורים פרטיים": "הדר יוסף/נאות אפקה",
                "Craftoola": "הדר יוסף/נאות אפקה",
                "Creata": "הדר יוסף/נאות אפקה",
                "סטודיו לא מושלם": "הדר יוסף/נאות אפקה",
                "סטודיו סומו": "הדר יוסף/נאות אפקה",
                "סטודיו בדינה": "הדר יוסף/נאות אפקה",
                "מרכז ספורט והעשרה נעמי שמר": "תל ברוך צפון"
            };

            let filteredActivities = activities;
            if (selectedNeighborhood) {
                filteredActivities = filteredActivities.filter(activity => neighborhoodMap[activity.center] === selectedNeighborhood);
            }
            if (selectedType) {
                filteredActivities = filteredActivities.filter(activity => activity.type === selectedType);
            }

            const centers = [...new Set(filteredActivities.map(activity => activity.center))];
            centers.sort();
            
            centerFilter.innerHTML = '<option value="">כל המקומות</option>'; // Reset and add default
            
            centers.forEach(center => {
                const option = document.createElement('option');
                option.value = center;
                option.textContent = center;
                centerFilter.appendChild(option);
            });
        }

        /**
         * Groups activities by name and center.
         * @param {Array} activitiesArray - The array of activity objects to group.
         * @returns {Array} - An array of grouped activity objects.
         */
        function groupActivities(activitiesArray) {
            const neighborhoodMap = {
                "בית ספר מגן": "מעוז אביב",
                "חוג עצמאי - מעוז אביב": "מעוז אביב",
                "מורים פרטיים": "מעוז אביב",
                "הסדנאות של מורי": "מעוז אביב",
                "בית פרנקפורט": "הדר יוסף/נאות אפקה",
                "המרכז האולימפי": "הדר יוסף/נאות אפקה",
                "מרכז קהילתי הדר אפקה": "הדר יוסף/נאות אפקה",
                "קאנטרי נאות אפקה": "הדר יוסף/נאות אפקה",
                "בית ספר גיל": "הדר יוסף/נאות אפקה",
                "בית ספר דוד ילין": "הדר יוסף/נאות אפקה",
                "מורים פרטיים": "הדר יוסף/נאות אפקה",
                "Craftoola": "הדר יוסף/נאות אפקה",
                "Creata": "הדר יוסף/נאות אפקה",
                "סטודיו לא מושלם": "הדר יוסף/נאות אפקה",
                "סטודיו סומו": "הדר יוסף/נאות אפקה",
                "סטודיו בדינה": "הדר יוסף/נאות אפקה",
                "מרכז ספורט והעשרה נעמי שמר": "תל ברוך צפון"
            };

            const grouped = {};
            activitiesArray.forEach(activity => {
                const key = `${activity.name}-${activity.center}`; // Unique key per activity type at a center
                if (!grouped[key]) {
                    grouped[key] = {
                        name: activity.name,
                        instructor: activity.instructor,
                        center: activity.center,
                        category: activity.category,
                        location: activity.location,
                        contact: activity.contact,
                        description: activity.description,
                        neighborhood: neighborhoodMap[activity.center] || null,
                        type: activity.type,
                        groups: [],
                        allAgeTags: new Set(),
                        allDays: new Set()
                    };
                }
                grouped[key].groups.push({
                    age: activity.age,
                    time: activity.time,
                    day: activity.day
                });
                if(activity.ageTags) {
                    activity.ageTags.forEach(tag => grouped[key].allAgeTags.add(tag));
                }
                if(activity.day) {
                    activity.day.split(' ו').forEach(d => grouped[key].allDays.add(d.trim()));
                }
            });
            
            Object.values(grouped).forEach(group => {
                group.allAgeTags = Array.from(group.allAgeTags);
                group.allDays = Array.from(group.allDays);
                 // If an instructor is not consistent, generalize it
                const instructors = new Set(activitiesArray.filter(a => a.name === group.name && a.center === group.center).map(a => a.instructor));
                if (instructors.size > 1) {
                    group.instructor = "צוות מדריכים";
                }
            });
            return Object.values(grouped);
        }


        /**
         * Renders the list of activities to the grid.
         * @param {Array} activitiesToRender - The array of grouped activity objects to display.
         */
        function renderActivities(activitiesToRender) {
            grid.innerHTML = ''; // Clear existing cards

            if (activitiesToRender.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
            }

            activitiesToRender.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col justify-between transform hover:-translate-y-1 transition-transform duration-300';
                
                const groupsHtml = activity.groups.map(group => `
                    <div class="flex items-center justify-between py-2 border-b last:border-b-0">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 ml-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-3-5.197m0 0A4 4 0 0012 4.354m0 5.292a4 4 0 010 5.292"></path></svg>
                            <span class="font-semibold">${group.age}</span>
                        </div>
                        <span class="text-sm text-gray-600">${group.day}, ${group.time}</span>
                    </div>
                `).join('');

                let contactHtml = '';
                if (activity.contact && activity.contact.phone) {
                    contactHtml += `
                        <a href="tel:${activity.contact.phone}" class="flex-1 text-center block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            <span>${activity.contact.phone}</span>
                        </a>`;
                }
                if (activity.contact && activity.contact.email) {
                    contactHtml += `
                        <a href="mailto:${activity.contact.email}" class="flex-1 text-center block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span>שלח מייל</span>
                        </a>`;
                }
                if (activity.contact && activity.contact.whatsapp) {
                    contactHtml += `
                        <a href="https://wa.me/${activity.contact.whatsapp}" target="_blank" class="flex-1 text-center block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.654 4.515 1.965 6.397l-1.566 5.722 5.86-1.532z"/></svg>
                            <span>שלח וואטסאפ</span>
                        </a>`;
                }
                if (activity.contact && activity.contact.whatsappGroup) {
                    contactHtml += `
                        <a href="${activity.contact.whatsappGroup}" target="_blank" class="flex-1 text-center block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                           <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.654 4.515 1.965 6.397l-1.566 5.722 5.86-1.532z"/></svg>
                            <span>${activity.contact.person}</span>
                        </a>`;
                }


                card.innerHTML = `
                    <div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-2xl font-bold text-gray-800">${activity.name}</h2>
                                <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${activity.center}</span>
                            </div>
                            <p class="text-md text-gray-600 font-semibold mb-2">${activity.instructor}</p>
                             <div class="flex items-center text-sm text-gray-500 mb-4">
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>${activity.location}</span>
                            </div>
                            ${activity.description ? `<p class="text-sm text-gray-600 mt-2 mb-4">${activity.description}</p>` : ''}
                            <div class="space-y-1 text-gray-800">
                                ${groupsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 mt-auto border-t border-gray-200">
                        <div class="flex gap-2 justify-center">
                            ${contactHtml}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        /**
         * Filters the activities based on the current filter values.
         */
        function filterAndRender() {
            const groupedActivities = groupActivities(activities);
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCenter = centerFilter.value;
            const selectedDay = dayFilter.value;
            const selectedAge = ageFilter.value;
            const selectedCategory = categoryFilter.value;
            const selectedNeighborhood = neighborhoodFilter.value;
            const selectedType = typeFilter.value;

            const filtered = groupedActivities.filter(activity => {
                const matchesSearch = activity.name.toLowerCase().includes(searchTerm) || activity.instructor.toLowerCase().includes(searchTerm);
                const matchesCenter = !selectedCenter || activity.center === selectedCenter;
                const matchesDay = !selectedDay || activity.allDays.some(day => day.includes(selectedDay));
                const matchesAge = !selectedAge || activity.allAgeTags.includes(selectedAge);
                const matchesCategory = !selectedCategory || activity.category === selectedCategory;
                const matchesNeighborhood = !selectedNeighborhood || activity.neighborhood === selectedNeighborhood;
                const matchesType = !selectedType || activity.type === selectedType;

                return matchesSearch && matchesCenter && matchesDay && matchesAge && matchesCategory && matchesNeighborhood && matchesType;
            });

            renderActivities(filtered);
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', filterAndRender);
        centerFilter.addEventListener('change', filterAndRender);
        dayFilter.addEventListener('change', filterAndRender);
        ageFilter.addEventListener('change', filterAndRender);
        categoryFilter.addEventListener('change', filterAndRender);
        typeFilter.addEventListener('change', () => {
            populateCenterFilter(neighborhoodFilter.value, typeFilter.value);
            filterAndRender();
        });
        neighborhoodFilter.addEventListener('change', () => {
            populateCenterFilter(neighborhoodFilter.value, typeFilter.value);
            filterAndRender();
        });

        // --- INITIALIZATION ---
        async function initializeApp() {
            setLastUpdatedDate();
            
            // Show loading message
            grid.innerHTML = '<div class="col-span-full text-center py-16"><h3 class="text-2xl font-semibold text-gray-700">טוען חוגים...</h3></div>';
            
            // Fetch activities from Supabase
            await fetchActivities();
            
            // Initialize filters and render
            populateCenterFilter();
            filterAndRender();
        }

        // Initialize the app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>

</body>
</html>
